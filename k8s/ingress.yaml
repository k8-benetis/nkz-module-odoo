# Nekazari Odoo ERP Module - Ingress Configuration
#
# Exposes the Odoo module frontend and backend via Traefik ingress.
#
# Author: Kate Benetis <kate@robotika.cloud>
# Company: Robotika
# License: AGPL-3.0

---
# Middleware to strip /modules/odoo-erp prefix
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-odoo-erp
  namespace: nekazari
spec:
  stripPrefix:
    prefixes:
      - /modules/odoo-erp

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: odoo-module-ingress
  namespace: nekazari
  labels:
    app: odoo-frontend
    module: odoo-erp
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: nekazari-strip-odoo-erp@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    # Frontend module (React UI)
    - host: nekazari.artotxiki.com
      http:
        paths:
          - path: /modules/odoo-erp
            pathType: Prefix
            backend:
              service:
                name: odoo-frontend-service
                port:
                  number: 80
  tls:
    - hosts:
        - nekazari.artotxiki.com
      secretName: nekazari-tls

---
# Backend API ingress (no prefix stripping needed)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: odoo-api-ingress
  namespace: nekazari
  labels:
    app: odoo-backend
    module: odoo-erp
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  ingressClassName: traefik
  rules:
    - host: nkz.artotxiki.com
      http:
        paths:
          - path: /api/odoo
            pathType: Prefix
            backend:
              service:
                name: odoo-backend-service
                port:
                  number: 80
  tls:
    - hosts:
        - nkz.artotxiki.com
      secretName: nekazari-tls

---
# Odoo direct access at odoo.nkz.artotxiki.com
# Uses dedicated certificate for iframe embedding
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: odoo-direct-ingress
  namespace: nekazari
  labels:
    app: odoo
    module: odoo-erp
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  ingressClassName: traefik
  rules:
    - host: odoo.nkz.artotxiki.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: odoo-service
                port:
                  number: 8069
  tls:
    - hosts:
        - odoo.nkz.artotxiki.com
      secretName: odoo-tls
